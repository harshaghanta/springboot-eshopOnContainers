name: "Build and push image"
description: "Builds and pushes an image to a registry"

inputs:
  service:
    description: 'Service to build'
    required: true
  registry_host:
    description: 'Docker image registry'
    required: true
  registry_endpoint:
    description: 'Docker image registry endpoint'
    required: true
  image_name:
    description: 'Name of the docker registry'
    required: true
  registry_username:
    description: 'username for the docker registry'
    required: true
  registry_password:
    description: 'password for the docker registry'
    required: true

runs:
  using: "composite"
  steps:
  - name: Login to registry
    uses: docker/login-action@v2
    with:
      registry: ${{ inputs.registry_host }}
      username: ${{ inputs.registry_username }}
      password: ${{ inputs.registry_password }}

  - name: Compose Build ${{ inputs.service }}
    shell: bash
    run: sudo -E docker compose build  ${{ inputs.service }}
    working-directory: ./src
    env:
      REGISTRY: harshaghanta

  - name: Compose Push ${{ inputs.service }}
    shell: bash
    run: sudo -E docker compose push ${{ inputs.service }}
    working-directory: ./src
    env:
      REGISTRY: harshaghanta
